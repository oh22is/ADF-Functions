{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "defaultValue": "westeurope",
            "type": "String"
        },
        "functionDynamics365Name": {
            "defaultValue": "func-dotnet-dynamics365-",
            "type": "String"
        },        
        "functionDynamicsStorageAccountName": {
            "defaultValue": "stfuncdynamics365-",
            "type": "String"
        },

        "functionHashGenerationName": {
            "defaultValue": "func-dotnet-hashgeneration-",
            "type": "String"
        },
        "functionHashGenerationStorageAccountName": {
            "defaultValue": "stfunchashgen-",
            "type": "String"
        },

        "functionNotificationsName": {
            "defaultValue": "func-dotnet-notifications-",
            "type": "String"
        },
        "functionNotificationsStorageAccountName": {
            "defaultValue": "stfuncnotifi-",
            "type": "String"
        },

        "functionFileMergeName": {
            "defaultValue": "func-python-filemerge-",
            "type": "String"
        },
        "functionFileMergeStorageAccountName": {
            "defaultValue": "stfuncfilemerge-",
            "type": "String"
        },  

        "functionProfilingName": {
            "defaultValue": "func-python-profiling-",
            "type": "String"
        },
        "functionProfilingStorageAccountName": {
            "defaultValue": "stfuncprof-",
            "type": "String"
        },  

        "functionDeployBranchToADFName": {
            "defaultValue": "func-powershell-deploybranchtoadf-",
            "type": "String"
        },
        "functionDeployBranchToADFStorageAccountName": {
            "defaultValue": "stfuncdeploybranch-",
            "type": "String"
        },  

        "functionSynapseBuilderName": {
            "defaultValue": "func-dotnet-synapsebuilder-",
            "type": "String"
        },
        "functionSynapseBuilderStorageAccountName": {
            "defaultValue": "stfuncsynbuilder-",
            "type": "String"
        }, 

        "functionsAlwaysOn": {
            "defaultValue": false,
            "type": "Bool"
        },

        "functionsUse32BitWorkerProcess": {
            "defaultValue": true,
            "type": "Bool"
        },      


        "funcHostingPlanName": {
            "defaultValue": "plan-",
            "type": "String"
        },
        "hostingPlanSkuName": {
            "allowedValues": [
                "F1",
                "B1",
                "P1v2",
                "P2v2",
                "P3v2",
                "P1V3",
                "P2v3",
                "P3v3"
            ],            
            "defaultValue": "P1v2",
            "type": "String"
        },
        "hostingPlanSkuTier": {
            "allowedValues": [
                "Free",
                "Basic",
                "PremiumV2",
                "PremiumV3"
            ],
            "defaultValue": "PremiumV2",
            "type": "String"
        },
        "hostingPlanWorkerSize": {
            "defaultValue": "0",
            "type": "String"
        },
        "hostingPlanWorkerSizeId": {
            "defaultValue": "0",
            "type": "String"
        },
        "hostingPlanNumberOfWorkers": {
            "defaultValue": "1",
            "type": "String"
        }                    
    },

    "functions": [],

    "variables": {
        "artifactsLocationUri": "https://raw.githubusercontent.com/oh22is/ADF-Functions/main/",
        "nestedTemplateUriPlanLinux":               "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/plan.linux.deploy.json'))]",
        "nestedTemplateUriPlanWindows":             "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/plan.windows.deploy.json'))]",
        "nestedTemplateUriFuncDynamics365":         "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.dynamics365.deploy.json'))]",
        "nestedTemplateUriFuncProfiling":           "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.profiling.deploy.json'))]",
        "nestedTemplateUriFuncHashGeneration":      "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.hashgeneration.deploy.json'))]",
        "nestedTemplateUriFuncFileMerge":           "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.filemerge.deploy.json'))]",
        "nestedTemplateUriFuncNotifications":       "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.notifications.deploy.json'))]",
        "nestedTemplateUriFuncDeployBranchToADF":   "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.deployBranchToADF.deploy.json'))]",
        "nestedTemplateUriFuncSynapseBuilder":      "[uri(variables('artifactsLocationUri'), concat('nestedtemplates/func.deployBranchToADF.deploy.json'))]"
    },
    "resources": [
        {
            "apiVersion": "2020-06-01",
            "name": "pid-0d687f89-584c-4ea6-a25e-436b2c363671",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },

        {
            "apiVersion": "2020-06-01",
            "name": "deploy_plan_linux",
            "condition": true,        
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriPlanLinux')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "hostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "hostingPlanSkuName": {
                        "value": "[parameters('hostingPlanSkuName')]"
                    },
                    "hostingPlanSkuTier": {
                        "value": "[parameters('hostingPlanSkuTier')]"
                    },
                    "hostingPlanWorkerSize": {
                        "value": "[parameters('hostingPlanWorkerSize')]"
                    },
                    "hostingPlanWorkerSizeId": {
                        "value": "[parameters('hostingPlanWorkerSizeId')]"
                    },
                    "hostingPlanNumberOfWorkers": {
                        "value": "[parameters('hostingPlanNumberOfWorkers')]"
                    }                
                }
            }
        },
  
        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_dynamics365",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncDynamics365')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionDynamics365Name')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionDynamicsStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        },

        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_filemerge",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncFileMerge')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionFileMergeName')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionFileMergeStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        },

        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_hashgeneration",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncHashGeneration')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionHashGenerationName')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionHashGenerationStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        },

        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_notifications",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncNotifications')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionNotificationsName')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionNotificationsStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        },

        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_profiling",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncProfiling')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionProfilingName')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionProfilingStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        },
        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_deploybranchtoadf",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncDeployBranchToADF')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionDeployBranchToADFName')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionDeployBranchToADFStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        },
        {
            "apiVersion": "2020-06-01",
            "name": "deploy_function_synapsebuilder",
            "condition": true,
            "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'deploy_plan_linux')]"
            ],            
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                        "uri": "[variables('nestedTemplateUriFuncSynapseBuilder')]"
                },
                "parameters": {  
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "funcName": {
                        "value": "[parameters('functionSynapseBuilderName')]"
                    },
                    "funcStorageAccountName": {
                        "value": "[parameters('functionSynapseBuilderStorageAccountName')]"
                    },
                    "funcHostingPlanName": {
                        "value": "[parameters('funcHostingPlanName')]"
                    },
                    "functionsAlwaysOn": {
                        "value": "[parameters('functionsAlwaysOn')]"
                    },
                    "functionsUse32BitWorkerProcess": {
                        "value": "[parameters('functionsUse32BitWorkerProcess')]"
                    }              
                }
            }
        }                           
    ],
    "outputs": {}
}